// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  BANK_TRANSFER
  CHECK
  CASH
  OTHER
}

// Ledger Core enums (append-only accounting layer)
enum LedgerAccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum LedgerEntryDirection {
  DEBIT
  CREDIT
}

// Organization model - represents a tenant
model Organization {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  email       String?
  phone       String?
  address     String?
  city        String?
  state       String?
  zipCode     String?
  country     String?
  taxId       String?
  logoUrl     String?
  isActive    Boolean  @default(true)
  deletedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userOrganizations   UserOrganization[]
  roles               Role[]
  clients             Client[]
  invoices            Invoice[]
  payments            Payment[]
  ledgerAccounts      LedgerAccount[]
  ledgerTransactions  LedgerTransaction[]

  @@index([slug])
  @@index([isActive, deletedAt])
  @@map("organizations")
}

// User model - can belong to multiple organizations
model User {
  id             String   @id @default(uuid())
  email          String   @unique
  passwordHash   String
  firstName      String
  lastName       String
  isActive       Boolean  @default(true)
  lastLoginAt    DateTime?
  deletedAt      DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  userOrganizations UserOrganization[]

  @@index([email])
  @@index([isActive, deletedAt])
  @@map("users")
}

// Many-to-many relationship between User and Organization
model UserOrganization {
  id             String   @id @default(uuid())
  userId         String
  organizationId String
  roleId         String
  isActive       Boolean  @default(true)
  deletedAt      DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role         Role         @relation(fields: [roleId], references: [id], onDelete: Restrict)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([roleId])
  @@index([isActive, deletedAt])
  @@map("user_organizations")
}

// Role model - organization-specific roles
model Role {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  permissions    Json?    // Store permissions as JSON
  isActive       Boolean  @default(true)
  deletedAt      DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization      Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userOrganizations UserOrganization[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([isActive, deletedAt])
  @@map("roles")
}

// Client model - organization-specific clients
model Client {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  email          String?
  phone          String?
  address        String?
  city           String?
  state          String?
  zipCode        String?
  country        String?
  taxId          String?
  isActive       Boolean  @default(true)
  deletedAt      DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices     Invoice[]

  @@index([organizationId])
  @@index([email])
  @@index([isActive, deletedAt])
  @@map("clients")
}

// Invoice model
model Invoice {
  id             String        @id @default(uuid())
  invoiceNumber  String
  organizationId String
  clientId       String
  issueDate      DateTime      @default(now())
  dueDate        DateTime
  status         InvoiceStatus @default(DRAFT)
  subtotal       Decimal       @db.Decimal(10, 2)
  taxRate        Decimal       @default(0) @db.Decimal(6, 2)
  taxAmount      Decimal       @default(0) @db.Decimal(10, 2)
  total          Decimal       @db.Decimal(10, 2)
  currency       String        @default("USD")
  notes          String?
  metadata       Json?
  deletedAt      DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Restrict)
  items        InvoiceItem[]
  payments     Payment[]

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId])
  @@index([clientId])
  @@index([status])
  @@index([dueDate])
  @@index([deletedAt])
  @@map("invoices")
}

// InvoiceItem model (renamed from InvoiceLineItem)
model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  description String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(10, 2)
  total       Decimal  @db.Decimal(10, 2)
  deletedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([deletedAt])
  @@map("invoice_items")
}

// Payment model
model Payment {
  id             String        @id @default(uuid())
  organizationId String
  invoiceId      String?
  amount         Decimal       @db.Decimal(10, 2)
  currency       String        @default("USD")
  method         PaymentMethod
  status         PaymentStatus @default(PENDING)
  transactionId  String?      @unique
  processedAt    DateTime?
  notes          String?
  metadata       Json?
  deletedAt      DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice      Invoice?    @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([invoiceId])
  @@index([status])
  @@index([transactionId])
  @@index([processedAt])
  @@index([deletedAt])
  @@map("payments")
}

// --- Ledger Core (append-only accounting truth layer) ---

model LedgerAccount {
  id             String           @id @default(uuid())
  organizationId String
  name           String
  type           LedgerAccountType
  currency       String           @default("USD")

  // Relations
  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  entries      LedgerEntry[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([type])
  @@map("ledger_accounts")
}

model LedgerTransaction {
  id             String   @id @default(uuid())
  organizationId String
  referenceType  String   // e.g. "INVOICE", "PAYMENT"
  referenceId    String
  createdAt      DateTime @default(now())

  // Relations
  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  entries      LedgerEntry[]
  hash         LedgerHash?

  @@unique([organizationId, referenceType, referenceId])
  @@index([organizationId])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@map("ledger_transactions")
}

model LedgerEntry {
  id                  String              @id @default(uuid())
  ledgerTransactionId  String
  accountId           String
  direction           LedgerEntryDirection
  amount              BigInt              // Integer monetary value (e.g. cents)

  // Relations
  ledgerTransaction LedgerTransaction @relation(fields: [ledgerTransactionId], references: [id], onDelete: Cascade)
  account          LedgerAccount     @relation(fields: [accountId], references: [id], onDelete: Restrict)

  @@index([ledgerTransactionId])
  @@index([accountId])
  @@map("ledger_entries")
}

model LedgerHash {
  ledgerTransactionId String
  previousHash       String?  // Null for first transaction
  currentHash        String

  // Relations
  ledgerTransaction LedgerTransaction @relation(fields: [ledgerTransactionId], references: [id], onDelete: Cascade)

  @@id([ledgerTransactionId])
  @@map("ledger_hashes")
}
